#!/bin/bash
# Fix broken catalog_category_product_index after import
# Usage: bin/fix-index

echo "Adding new products to index..."

docker-compose exec -T db mysql -u magento -pmagento magento << 'SQL'
-- Step 1: Add products to their directly assigned categories
INSERT IGNORE INTO catalog_category_product_index
(category_id, product_id, position, is_parent, store_id, visibility)
SELECT
    ccp.category_id,
    ccp.product_id,
    COALESCE(ccp.position, 0),
    0,  -- is_parent = 0 for direct assignment
    1,
    COALESCE(cpei.value, 4)
FROM catalog_category_product ccp
JOIN catalog_product_entity cpe ON ccp.product_id = cpe.entity_id
LEFT JOIN catalog_product_entity_int cpei ON ccp.product_id = cpei.entity_id
    AND cpei.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'visibility' AND entity_type_id = 4);

-- Step 2: Add products to ALL parent categories (for artist/album pages to work)
INSERT IGNORE INTO catalog_category_product_index
(category_id, product_id, position, is_parent, store_id, visibility)
SELECT DISTINCT
    parent_cat.entity_id as category_id,
    ccpi.product_id,
    ccpi.position,
    1,  -- is_parent = 1 for inherited from child
    1,
    ccpi.visibility
FROM catalog_category_product_index ccpi
JOIN catalog_category_entity child_cat ON ccpi.category_id = child_cat.entity_id
JOIN catalog_category_entity parent_cat ON FIND_IN_SET(parent_cat.entity_id, REPLACE(child_cat.path, '/', ','))
WHERE parent_cat.entity_id != child_cat.entity_id
  AND parent_cat.level >= 2;  -- Skip root categories

SELECT CONCAT('✅ Base index updated. Total products: ', COUNT(*)) as result
FROM catalog_category_product_index;

-- Step 3: Sync to store1 table (required for GraphQL queries)
-- First, add products to their directly assigned categories in store1 table
INSERT IGNORE INTO catalog_category_product_index_store1
(category_id, product_id, position, is_parent, store_id, visibility)
SELECT
    ccp.category_id,
    ccp.product_id,
    COALESCE(ccp.position, 0),
    0,  -- is_parent = 0 for direct assignment
    1,
    COALESCE(cpei.value, 4)
FROM catalog_category_product ccp
JOIN catalog_product_entity cpe ON ccp.product_id = cpe.entity_id
LEFT JOIN catalog_product_entity_int cpei ON ccp.product_id = cpei.entity_id
    AND cpei.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'visibility' AND entity_type_id = 4);

-- Step 4: Add products to parent categories in store1 table
INSERT IGNORE INTO catalog_category_product_index_store1
(category_id, product_id, position, is_parent, store_id, visibility)
SELECT DISTINCT
    parent_cat.entity_id as category_id,
    ccpi.product_id,
    ccpi.position,
    1,  -- is_parent = 1 for inherited from child
    1,
    ccpi.visibility
FROM catalog_category_product_index_store1 ccpi
JOIN catalog_category_entity child_cat ON ccpi.category_id = child_cat.entity_id
JOIN catalog_category_entity parent_cat ON FIND_IN_SET(parent_cat.entity_id, REPLACE(child_cat.path, '/', ','))
WHERE parent_cat.entity_id != child_cat.entity_id
  AND parent_cat.level >= 2;  -- Skip root categories

SELECT CONCAT('✅ Store1 index updated. Total products: ', COUNT(*)) as result
FROM catalog_category_product_index_store1;
SQL

echo ""
echo "Flushing cache..."
docker-compose exec -T phpfpm bin/magento cache:flush > /dev/null
echo "✅ Done!"
