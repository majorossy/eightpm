#!/usr/bin/env bash
# Stop frontend process on port 3001
# Handles both PM2 (production) and direct node (development)

# Check if PM2 is managing the frontend
if command -v pm2 &> /dev/null && pm2 list 2>/dev/null | grep -q '8pm-frontend.*online'; then
  echo "Stopping frontend via PM2..."
  pm2 stop 8pm-frontend 2>/dev/null || true
  sleep 1
  echo "✓ Frontend stopped (PM2)"
  exit 0
fi

# Fallback: kill process directly (development mode)
PID=""
if command -v lsof &> /dev/null; then
  PID=$(lsof -ti:3001 2>/dev/null || true)
fi
if [ -z "$PID" ] && command -v ss &> /dev/null; then
  PID=$(ss -tlnp 2>/dev/null | grep ':3001 ' | sed -n 's/.*pid=\([0-9]*\).*/\1/p' | head -1)
fi

if [ -z "$PID" ] || [ "$PID" = "0" ]; then
  echo "✓ No frontend process running"
  exit 0
fi

# Find parent npm process
PARENT_PID=$(ps -o ppid= -p $PID 2>/dev/null | tr -d ' ')
KILL_PID=$PID

if [ -n "$PARENT_PID" ] && [ "$PARENT_PID" != "1" ]; then
  PARENT_CMD=$(ps -o command= -p $PARENT_PID 2>/dev/null || true)
  if echo "$PARENT_CMD" | grep -qE 'npm|node|next'; then
    KILL_PID=$PARENT_PID
  fi
fi

echo "Stopping frontend (PID: $KILL_PID)..."

# Graceful shutdown: SIGTERM first, wait, then SIGKILL if needed
kill -15 $KILL_PID 2>/dev/null || true
sleep 2

# Check if still running
if kill -0 $KILL_PID 2>/dev/null; then
  echo "  Process didn't exit gracefully, forcing..."
  kill -9 $KILL_PID 2>/dev/null || true
  sleep 1
fi

# Verify port is free
if ss -tlnp 2>/dev/null | grep -q ':3001 '; then
  echo "⚠ Warning: Port 3001 still in use"
  exit 1
else
  echo "✓ Frontend stopped"
fi
